---
title: "Indoor Positioning System"
author: "Sang Xing"
subtitle: "STAT 410"
format: 
  html:
    fig-width: 8
    fig-height: 4
    theme:
      dark: darkly
      light: flatly
    toc: true
    toc-title: Contents
    toc-depth: 4
    toc-location: right
    number-sections: false
    number-depth: 3
    anchor-sections: true
    smooth-scroll: true
    link-external-icon: false
    link-external-newwindow: true
    code-fold: true
    code-tools: 
      source: true
      toggle: true
      caption: none
    code-overflow: scroll
    code-summary: "Show the code"
    highlight-style: atom-one
    link-external-filter: '^(?:http:|https:)\/\/www\.quarto\.org\/custom'
    html-math-method:
      method: mathjax
      url: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
---

```{css, echo=FALSE}
h1.title, .subtitle.lead{
  text-align: center;
}

div.quarto-title-meta{
  display: block!important;
  text-align: center;
}
```

```{r include=FALSE}
#knitr::opts_chunk$set(
#   echo = FALSE,                 # don't show code
#   warning = FALSE,              # don't show warnings
#   message = FALSE,              # don't show messages (less serious warnings)
#   cache = FALSE,                # set to TRUE to save results from last compilation
#   fig.align = "center",         # center figures
#   fig.width = ,                 # Adjust figure width
#   fig.height = ,                # Adjust figure height
#   attr.source = '.numberLines'  # add line numbers to code
#   class.output = "numberLines"  # add line numbers to code output
# )

# Keyboard Shortcut
# Alt + (-)           Inserts the assignment operator with spaces surrounding it.
# Ctrl + Shift + M    Inserts the magrittr/pipe operator (%>%) with spaces surrounding it.
# Ctrl + Shift + R    Creates a foldable comment section in your code. These are used for code externalization with knitr:read_chunk() function. Learn more.
# Alt + L             Collapse active section.
# Alt + O             Collapse all sections.
# Alt + Shift + L     Open active section.
# Alt + Shift + O     Open all sections

library(tidyverse)  # Load core packages: 
                    # ggplot2,   for data visualization.
                    # dplyr,     for data manipulation.
                    # tidyr,     for data tidying.
                    # purrr,     for functional programming.
                    # tibble,    for tibbles, a modern re-imagining of data frames.
                    # stringr,   for strings.
                    # forcats,   for factors.
                    # lubridate, for date/times.
                    # readr,     for reading .csv, .tsv, and .fwf files.
                    # readxl,    for reading .xls, and .xlxs files.
                    # feather,   for sharing with Python and other languages.
                    # haven,     for SPSS, SAS and Stata files.
                    # httr,      for web apis.
                    # jsonlite   for JSON.
                    # rvest,     for web scraping.
                    # xml2,      for XML.
                    # modelr,    for modelling within a pipeline
                    # broom,     for turning models into tidy data
                    # hms,       for times.

library(magrittr)   # Pipeline operator
library(lobstr)     # Visualizing abstract syntax trees, stack trees, and object sizes
library(pander)     # Exporting/converting complex pandoc documents, EX: df to Pandoc table
library(ggforce)    # More plot functions on top of ggplot2
library(ggpubr)     # Automatically add p-values and significance levels  plots. 
                    # Arrange and annotate multiple plots on the same page. 
                    # Change graphical parameters such as colors and labels.
library(sf)         # Geo-spatial vector manipulation: points, lines, polygons
library(kableExtra) # Generate 90 % of complex/advanced/self-customized/beautiful tables
library(latex2exp)  # Latex axis titles in ggplot2
library(ellipse)    # Simultaneous confidence interval region to check C.I. of 2 slope parameters
library(plotly)     # User interactive plots

set.seed(27)        # make random results reproducible
setwd("C:/Users/sangb/Desktop/School/Classes/STAT/STAT 410/Code")
```



### Data Cleaning
```{r Step_1.Data_Cleaning}
# Load txt files
offline_data_txt <- readLines("offline.final.trace.txt")
online_data_txt  <- readLines("online.final.trace.txt")

# To split the text into rows, then piece together column names and rows of data
processLine <- function(x) {
  #Regex to split data on ;=, characters (determined by looking at data)
  tokens = strsplit(x, "[;=,]")[[1]]
  #If no signals are recorded (token length is 10) then remove the row
  if (length(tokens) == 10)
    return(NULL)
  #For each signal recording, tokens 1, 3, 5, and 9 are column names
  tmp = matrix(tokens[-(1:10)], ncol=4, byrow=T)
  #Column bind column names with the other rows in matrix form
  cbind(matrix(tokens[c(2,4,6:8,10)], nrow=nrow(tmp), ncol=6, byrow=T), tmp)
}

# Run the processLine function over the entire dataset to build dataframe
offlines <- offline_data_txt[substr(offline_data_txt, 1,1) != "#"]  #Removes comments from data
offline_tmp   <- lapply(offlines, processLine)
onlines <- online_data_txt[substr(online_data_txt, 1,1) != "#"]  #Removes comments from data
online_tmp   <- lapply(onlines, processLine)

IPS_offline_Data <- as.data.frame(do.call("rbind", offline_tmp), stringsAsFactors=F)
IPS_online_Data  <- as.data.frame(do.call("rbind", online_tmp), stringsAsFactors=F)

# Add column names
names(IPS_offline_Data) <- c("timeStamp", "scanedMAC", "posX", "posY", "posZ", "orientation", "MAC", "RSSI", "frequency", "mode")
names(IPS_online_Data) <- c("timeStamp", "scanedMAC", "posX", "posY", "posZ", "orientation", "MAC", "RSSI", "frequency", "mode")
```



## Data Adjustment
```{r Step_2.rawData_DF_adjustment}
# Take only access point = 3, device in Ad-hoc mode = 1
IPS_offline_Data <- IPS_offline_Data[IPS_offline_Data$mode=="3",]

# Data coercion chr -> numeric
varList <- c("timeStamp", "posX", "posY", "posZ", "orientation", "RSSI")
IPS_offline_Data[varList] <- lapply(IPS_offline_Data[varList], as.numeric)
IPS_online_Data[varList] <- lapply(IPS_online_Data[varList], as.numeric)

# Convert timeStamp to millisecond for Unix time conversions
IPS_offline_Data$timeStamp <- IPS_offline_Data$timeStamp/1000 
IPS_offline_Data$timeStamp <- as.POSIXct(IPS_offline_Data$time, tz="UTC", origin = "1970-01-01")

IPS_online_Data$timeStamp <- IPS_online_Data$timeStamp/1000 
IPS_online_Data$timeStamp <- as.POSIXct(IPS_online_Data$time, tz="UTC", origin = "1970-01-01")

summary(sapply(IPS_offline_Data[,c("scanedMAC", "frequency", "MAC", "mode")], as.factor))
summary(sapply(IPS_online_Data[,c("scanedMAC", "frequency", "MAC", "mode")], as.factor))

#Since the scan device and the elevation (posZ) are constant, they can be dropped
# length(unique(IPS_offline_Data$scanedMAC))  #Output: 1
# length(unique(IPS_offline_Data$posZ))       #Output: 1
IPS_offline_Data$scanMac <- NULL
IPS_offline_Data$posZ <- NULL

# length(unique(IPS_online_Data$scanedMAC))   #Output: 1
# length(unique(IPS_online_Data$posZ))        #Output: 1
IPS_online_Data$scanMac <- NULL
IPS_online_Data$posZ <- NULL

#Clear unneeded objects
remove(offlines)
remove(onlines)
remove(offline_data_txt)
remove(online_data_txt)

# Export df to csv
write.csv(IPS_offline_Data,"C:\\Users\\sangb\\Desktop\\School\\Classes\\STAT\\STAT 410\\Code\\IPS_offline_Data.csv", row.names = FALSE)
write.csv(IPS_online_Data,"C:\\Users\\sangb\\Desktop\\School\\Classes\\STAT\\STAT 410\\Code\\IPS_online_Data.csv", row.names = FALSE)
```



## Data Import
```{r Step_3.Data_Import&Exploration}
# Import csv
library(readr)
IPS_offline_Data <- read_csv("IPS_online_Data.csv")
IPS_online_Data <- read_csv("IPS_online_Data.csv")
```



```{r Step_4.Data_}



```



